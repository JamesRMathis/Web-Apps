<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo</title>

    <link rel="stylesheet" href="/static/todo/css/style.css">
    <script src="/static/todo/js/script.js" defer></script>
    <script>
        function getLists() {
            fetch('/assignment7/todo/lists')
            .then(response => response.json())
            .then(lists => {
                console.log(Object.keys(lists));
                const listsDiv = document.getElementById('lists');
                listsDiv.innerHTML = '';
                
                const selectElement = document.getElementById('list')
                const existingOptions = new Set(Array.from(selectElement.options).map(option => option.value))
                Object.keys(lists).forEach(list => {
                    if (list === 'error') return

                    if (!existingOptions.has(list)) {
                        const option = document.createElement('option')
                        option.value = list
                        option.innerHTML = list
                        selectElement.appendChild(option)
                    }

                    const listElement = document.createElement('div');
                    listElement.innerHTML = `<h2>${list}</h2>`;
                    
                    if (!Array.isArray(lists[list])) {
                        lists[list] = [lists[list]]
                    }

                    listsDiv.appendChild(listElement);

                    const completed = lists[list].filter(task => task.completed)
                    const incomplete = lists[list].filter(task => !task.completed)

                    const completedElement = document.createElement('div')
                    completedElement.innerHTML = `<h3>Completed</h3>`
                    listElement.appendChild(completedElement)

                    const incompleteElement = document.createElement('div')
                    incompleteElement.innerHTML = `<h3>Incomplete</h3>`
                    listElement.appendChild(incompleteElement)

                    i = 0
                    lists[list].forEach(task => {
                        let checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = task.completed;

                        let taskElement = document.createElement('label');
                        taskElement.appendChild(checkbox);
                        taskElement.insertAdjacentHTML('beforeend', task.task);
                        (task.completed ? completedElement : incompleteElement).appendChild(taskElement);

                        function createOnCickHandler(i) {
                            return () => {
                            console.log(i, task.task);  
                            fetch(`/assignment7/todo/${list}/${task.task}/${i}/toggle`)
                            .then(response => response.json())
                            .then(response => {
                                if (!response.error) {
                                    getLists();
                                }
                            })}
                        }

                        checkbox.onclick = createOnCickHandler(i);

                        i++
                    });
                })
            });
        }
    </script>
</head>
<body onload="getLists()">
    <div id="lists"></div>

    <form action="" method="post" id="addTaskForm">
        <label for="task">Task</label>
        <input type="text" name="task" id="task">

        <label for="list">Which list should this task be added to?</label>
        <select name="list" id="list">
            <option value="new">New list</option>
        </select>

        <button type="submit">Submit</button>
    </form>

</body>
<script>
    const addTaskForm = document.getElementById('addTaskForm');
    console.log(addTaskForm);

    addTaskForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const formData = new FormData(addTaskForm);
        console.log(formData);
        const task = formData.get('task');
        const list = formData.get('list');
        console.log(task, list);

        fetch('/assignment7/todo/add', {
            method: 'POST',
            body: JSON.stringify({
                task: task,
                list: list
            })
        })
        .then(response => response.json())
        .then(response => {
            console.log('response: ' + response);
            if (!response.error) {
                document.cookie = `userid=${response.userid}`;
                getLists();
            }
        })
    })
</script>
</html>